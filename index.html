<!DOCTYPE html>
<head>
    <title>AT Transit Realtime</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="script-src 'self' https://unpkg.com https://cdnjs.cloudflare.com https://www.googletagmanager.com;">
    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
        integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
        crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-providers@1.3.0/leaflet-providers.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
    <script src="https://unpkg.com/leaflet-spin@1.1.0/leaflet.spin.min.js"></script>
    <script src="https://unpkg.com/leaflet-search@2.9.8/dist/leaflet-search.src.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.0.3/chroma.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.8/src/leaflet-search.css" />
    <style>
        body, html { width: 100%; height: 100%; margin: 0; padding: 0; }
        #map { position: absolute; width: 100%; height: 100%; left: 0; top: 0; }
        #title {
            position: absolute;
            top: 10px;
            left: 0; right: 0; margin: auto;
            z-index: 1000; width: 500px;
            text-align: center; color: white; border-radius: 5px; padding: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            font-size: 1rem; font-family: Arial, Helvetica, sans-serif;
            text-shadow: 2px 2px #000000; font-weight: normal;
        }
        .info {
            background-color: white; padding: 15px; color: black;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); border-radius: 5px;
        }
    </style>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-77710107-12"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-77710107-12');
    </script>
</head>
<body>
    <h1 id="title">Welcome to the Auckland Transport Transit Realtime Map!</h1>
    <div id="map"></div>
    <script>
        var map = L.map('map', {
            center: [-36.8862, 174.7651],
            zoom: 12,
            worldCopyJump: true
        });

        var positron = L.tileLayer.provider('CartoDB.Positron').addTo(map);

        var baseMaps = {
            "OSM": L.tileLayer.provider("OpenStreetMap.Mapnik"),
            "OSM Grayscale": L.tileLayer.provider("OpenStreetMap.BlackAndWhite"),
            "CartoDB Positron": positron,
            "CartoDB Dark Matter": L.tileLayer.provider("CartoDB.DarkMatter"),
            "ESRI WorldImagery": L.tileLayer.provider("Esri.WorldImagery"),
            "Google Hybrid": L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            }),
            "Wikimedia": L.tileLayer.provider("Wikimedia")
        }
<script>
  // === API KEYS ===
  const AT_KEY = "b122c467e7e145b7bfcd6d854d09b01b";
  const METROINFO_KEY = "70bec02cbae84bbfa29b4e906a2035d4";

  // === MAP INITIALISE ===
  var map = L.map('map').setView([-41.2, 174.8], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20
  }).addTo(map);

  // === GLOBALS ===
  var regionLayers = {
    "Auckland": L.layerGroup().addTo(map),
    "Wellington": L.layerGroup().addTo(map),
    "Christchurch": L.layerGroup().addTo(map),
    "Waikato": L.layerGroup().addTo(map)
  };
  var markers = {
    "Auckland": {},
    "Wellington": {},
    "Christchurch": {},
    "Waikato": {}
  };
  var occupancy = ["unknown", "empty", "many seats", "few seats", "full"];

  // === FUNCTIONS ===
  function updateMarkerColour(marker) {
    let occ = marker.occupancy_status || 0;
    let colour = "blue";
    if (occ === 1) colour = "green";
    else if (occ === 2) colour = "orange";
    else if (occ === 3) colour = "red";
    marker.setStyle({ color: colour });
  }

  function updateSearchLayer() {
    // (not fully fleshed, placeholder for your existing search logic)
  }

  // === FETCH FUNCTIONS ===

  // Auckland
  function fetchAuckland() {
    map.spin(true);
        fetch('https://api.at.govt.nz/gtfs/v3/routes', {
            method: 'GET',
            headers: {
                'Cache-Control': 'no-cache',
                'Ocp-Apim-Subscription-Key': 'b122c467e7e145b7bfcd6d854d09b01b',
            }
        })
        .then(response => response.json())
        .then(response => {
            map.spin(false);
            if (response.message) {
                console.error(response);
                $("#status").text(`Error getting routes: ${response.message}`);
            } else {
                for (var r of response.data) {
                    if (r.attributes.route_type == 712) r.attributes.route_type = 3;
                    routes[r.id] = r.attributes;
                }
            }
            loop();
        })
        .catch(err => {
            map.spin(false);
            console.error(err);
            $("#status").text("Error loading routes.");
        });

        function loop() {
            if (hasLoaded && !document.hasFocus()) {
                console.log("tab unfocused, skipping");
                return;
            }
            hasLoaded = true;

            fetch('https://api.at.govt.nz/realtime/legacy/vehiclelocations', {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Ocp-Apim-Subscription-Key': 'b122c467e7e145b7bfcd6d854d09b01b',
                }
            })
            .then(response => response.json())
            .then(data => {
                map.spin(false);
                for (var i in data.response.entity) {
                    var id = data.response.entity[i].id;
                    var v = data.response.entity[i].vehicle;
                    var desc = `<b>${v.vehicle.label}</b><br>`;
                    var layer = layers[null];
                    var marker = markers[id];
                    if (marker) {
                        marker.setLatLng([v.position.latitude, v.position.longitude]);
                    } else {
                        marker = L.circle([v.position.latitude, v.position.longitude], { radius: 20, desc: desc });
                        markers[id] = marker;
                        marker.on("tooltipopen", function (e) {
                            if (e.target.trip) {
                                fetch('https://api.at.govt.nz/gtfs/v3/trips/' + e.target.trip.trip_id, {
                                    method: 'GET',
                                    headers: {
                                        'Cache-Control': 'no-cache',
                                        'Ocp-Apim-Subscription-Key': 'b122c467e7e145b7bfcd6d854d09b01b',
                                    }
                                })
                                .then(response => response.json())
                                .then(response => {
                                    if (response.message) {
                                        console.error(response.message);
                                        $("#status").text(`Error getting trip: ${response.message}`);
                                    } else {
                                        $("#headsign").text(response.data.attributes.trip_headsign);
                                    }
                                })
                                .catch(err => console.error(err));
                            }
                        });
                    }
                    if (v.trip) {
                        var r = routes[v.trip.route_id];
                        marker.trip = v.trip;
                        if (r) {
                            desc += `Agency: ${r.agency_id}<br>Route: ${r.route_long_name}<br>Headsign: <div id="headsign"></div>`;
                            marker.options.desc = desc;
                            marker.route_long_name = r.route_long_name;
                            marker.route_type = r.route_type;
                            layer = layers[r.route_type];
                            if (!layer) {
                                console.error(r);
                                layer = layers[null];
                            }
                        } else {
                            layer = layers[null];
                        }
                    }

  // Wellington
  function fetchWellington() {
    fetch('https://gtfs-realtime-to-json.org/convert?url=https://api.opendata.metlink.org.nz/v1/gtfs-rt/vehicle-positions')
    .then(res => res.json())
    .then(data => {
      regionLayers["Wellington"].clearLayers();
      markers["Wellington"] = {};
      (data.entity || []).forEach(entity => {
        var latlng = [entity.vehicle.position.latitude, entity.vehicle.position.longitude];
        var occText = (entity.vehicle.occupancy_status || "unknown").toLowerCase();
        var occIdx = occupancy.indexOf(occText);
        var desc = `<b>${entity.vehicle.vehicle.label || entity.vehicle.vehicle.id}</b><br>Route: ${entity.vehicle.trip.route_id}<br>Occupancy: ${entity.vehicle.occupancy_status || "unknown"}`;
        var marker = L.circle(latlng, { radius: 20, desc: desc });
        marker.route_long_name = entity.vehicle.trip.route_id;
        marker.occupancy_status = occIdx === -1 ? 0 : occIdx;
        marker.speed = 0;
        marker.route_type = 3;
        marker.bindTooltip(desc);
        updateMarkerColour(marker);
        marker.addTo(regionLayers["Wellington"]);
        markers["Wellington"][entity.vehicle.vehicle.id] = marker;
      });
      updateSearchLayer();
    });
  }

  // Christchurch
  function fetchChristchurch() {
    fetch('https://apis.metroinfo.co.nz/rti/vehiclepositions', {
      headers: { 'Ocp-Apim-Subscription-Key': METROINFO_KEY }
    })
    .then(res => res.json())
    .then(data => {
      regionLayers["Christchurch"].clearLayers();
      markers["Christchurch"] = {};
      (data || []).forEach(entity => {
        var latlng = [entity.VehicleLocation.Latitude, entity.VehicleLocation.Longitude];
        var occText = (entity.Occupancy || "unknown").toLowerCase();
        var occIdx = occupancy.indexOf(occText);
        var desc = `<b>${entity.VehicleRef}</b><br>Route: ${entity.PublishedLineName}<br>To: ${entity.DestinationName}<br>Occupancy: ${entity.Occupancy || "unknown"}`;
        var marker = L.circle(latlng, { radius: 20, desc: desc });
        marker.route_long_name = entity.PublishedLineName;
        marker.occupancy_status = occIdx === -1 ? 0 : occIdx;
        marker.speed = 0;
        marker.route_type = 3;
        marker.bindTooltip(desc);
        updateMarkerColour(marker);
        marker.addTo(regionLayers["Christchurch"]);
        markers["Christchurch"][entity.VehicleRef] = marker;
      });
      updateSearchLayer();
    });
  }

  // Waikato
  function fetchWaikato() {
    fetch('https://busit.github.io/realtime-demo.json')
    .then(res => res.json())
    .then(data => {
      regionLayers["Waikato"].clearLayers();
      markers["Waikato"] = {};
      (data.vehicles || []).forEach(v => {
        var latlng = [v.lat, v.lon];
        var occText = (v.occupancy || "unknown").toLowerCase();
        var occIdx = occupancy.indexOf(occText);
        var desc = `<b>${v.id}</b><br>Route: ${v.route}<br>Plate: ${v.plate}<br>Occupancy: ${v.occupancy}<br>Speed: ${v.speed}`;
        var marker = L.circle(latlng, { radius: 20, desc: desc });
        marker.route_long_name = v.route;
        marker.occupancy_status = occIdx === -1 ? 0 : occIdx;
        marker.speed = v.speed;
        marker.route_type = 3;
        marker.bindTooltip(desc);
        updateMarkerColour(marker);
        marker.addTo(regionLayers["Waikato"]);
        markers["Waikato"][v.id] = marker;
      });
      updateSearchLayer();
    });
  }

  // === LOOPING REFRESH ===
  function refreshAll() {
    fetchAuckland();
    fetchWellington();
    fetchChristchurch();
    fetchWaikato();
  }

  refreshAll();
  setInterval(refreshAll, 30000); // refresh every 30s

</script>
</body>
</html>
